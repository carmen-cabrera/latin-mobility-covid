file_m3cats_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m3cats_re_new.csv')
# write.csv(m3cats_re[[1]], file_m3cats_re, row.names = FALSE)
###
file_m4cat_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m4cat_re_new.csv')
# write.csv(m4cat_re[[1]], file_m4cat_re, row.names = FALSE)
file_m4cats_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m4cats_re_new.csv')
# write.csv(m4cats_re[[1]], file_m4cats_re, row.names = FALSE)
###
file_m5cat_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m5cat_re_new.csv')
# write.csv(m5cat_re[[1]], file_m5cat_re, row.names = FALSE)
file_m5cats_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m5cats_re_new.csv')
# write.csv(m5cats_re[[1]], file_m5cats_re, row.names = FALSE)
###
file_m6cat_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m6cat_re_new.csv')
# write.csv(m6cat_re[[1]], file_m6cat_re, row.names = FALSE)
file_m6cats_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m6cats_re_new.csv')
# write.csv(m6cats_re[[1]], file_m6cats_re, row.names = FALSE)
###
file_m7cat_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m7cat_re_new.csv')
# write.csv(m7cat_re[[1]], file_m7cat_re, row.names = FALSE)
file_m7cats_re <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_param_', place, '_m7cats_re_new.csv')
# write.csv(m7cats_re[[1]], file_m7cats_re, row.names = FALSE)
# p1_m1me <- plot_model(m3o_re, terms = c("1", "time")) %>%
#   .$data %>% ggplot(aes(x=estimate, y=term, color=group)) +
#   geom_point(size = 3.5,  colour = "black") +
#   geom_errorbar(aes(xmin = conf.low, xmax = conf.high),
#                 width=.05, color= "black") +
#   geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
#   scale_color_manual(values=c("#88ccee")) +
#   theme(legend.position = "none",
#         axis.title.y = element_blank(),
#         axis.text = element_text(size = 10.5)
#   ) +
#   scale_y_discrete(labels=c("time" = "Week",
#                             "1" = "Intercept")) +
#   geom_vline(xintercept=0,
#              linetype="solid",
#              color = "grey20",
#              linewidth=1,
#              alpha =.2) +
#   labs(title = "Main fixed effects")
#
# p1_m1me
# m2_re <- plot_model(m,
#            type ="re", terms = "O")
#
# m2_re <- m2_re[[1]]$data
#
# p2_m2re <- m2_re %>% filter(facet == "O (Intercept)") %>%
#   ggplot(aes(x=estimate, y=term, color=group)) +
#   geom_point(size = 3.5,  colour = "black") +
#   geom_errorbar(aes(xmin = conf.low, xmax = conf.high),
#                 width=.8, color= "black") +
#   geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
#   scale_color_manual(values=c("#ddcc77", "#88ccee")) +
#   theme(legend.position = "none",
#         axis.title.y = element_blank(),
#         axis.text = element_text(size = 10.5)
#         ) +
#   geom_vline(xintercept=0,
#              linetype="solid",
#              color = "grey20",
#              size=1,
#              alpha =.2) +
#   labs(title = "d")
#
# p2_m2re
# eq <- y ~  time + (time | O) + (time | D)
# model <- glmmTMB(eq, data = df)
# pm3o <- plot_model(m3o, terms = c("time", "O")) %>%
#   .$df %>% ggplot(aes(x=estimate, y=term, color=group)) +
#   geom_point(size = 3.5,  colour = "black") +
#   geom_errorbar(aes(xmin = conf.low, xmax = conf.high),
#                 width=.05, color= "black") +
#   geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
#   scale_color_manual(values=c("#88ccee")) +
#   theme(legend.position = "none",
#         axis.title.y = element_blank(),
#         axis.text = element_text(size = 10.5)
#   ) +
#   scale_y_discrete(labels=c("z_stringency_index" = "Stringency t",
#                             "z_cases" = "New cases t",
#                             "lag(z_stringency_index, 1)" = "Stringency t-1")) +
#   geom_vline(xintercept=0,
#              linetype="solid",
#              color = "grey20",
#              linewidth=1,
#              alpha =.2) +
#   labs(title = "c",
#        subtitle = " Main fixed effects")
#
# p1_m
m3cat_re
m3cats_re
m4cat_re
m4cats_re
m5cat_re
m5cats_re
m6cat_re
m6cats_re
m7cat_re
m7cats_re
m6cat_re[[1]]$estimate[[6]]
m6cat$fit$par
# Create predicted data frame for time 1 to 1000
pred_df_1 <- tibble(time = 1:300, time2 = time^2,
fitted = (m6cat$fit$par[[1]] + m6cat_re[[1]]$estimate[[1]]) +
(m6cat$fit$par[[2]] + m6cat_re[[1]]$estimate[[6]]) * time +
m6cat$fit$par[[3]] * time2)
# Create predicted data frame for time 1 to 1000
pred_df_2 <- tibble(time = 1:300, time2 = time^2,
fitted = (m6cat$fit$par[[1]] + m6cat_re[[1]]$estimate[[2]]) +
(m6cat$fit$par[[2]] + m6cat_re[[1]]$estimate[[7]]) * time +
m6cat$fit$par[[3]] * time2)
# Create predicted data frame for time 1 to 1000
pred_df_3 <- tibble(time = 1:300, time2 = time^2,
fitted = (m6cat$fit$par[[1]] + m6cat_re[[1]]$estimate[[3]]) +
(m6cat$fit$par[[2]] + m6cat_re[[1]]$estimate[[8]]) * time +
m6cat$fit$par[[3]] * time2)
# Create predicted data frame for time 1 to 1000
pred_df_4 <- tibble(time = 1:300, time2 = time^2,
fitted = (m6cat$fit$par[[1]] + m6cat_re[[1]]$estimate[[4]]) +
(m6cat$fit$par[[2]] + m6cat_re[[1]]$estimate[[9]]) * time +
m6cat$fit$par[[3]] * time2)
# Create predicted data frame for time 1 to 1000
pred_df_5 <- tibble(time = 1:300, time2 = time^2,
fitted = (m6cat$fit$par[[1]] + m6cat_re[[1]]$estimate[[5]]) +
(m6cat$fit$par[[2]] + m6cat_re[[1]]$estimate[[10]]) * time +
m6cat$fit$par[[3]] * time2)
stringency <- FALSE
# Create new time sequence covering the range of your original data
new_time <- expand.grid(
time = seq(min(df$time), max(df$time)*100, length.out = max(df$time)*100-min(df$time)+1),
cat = levels(df$cat)   # one dataset per group
)
new_time <- new_time %>%
left_join(df[, c("time", "cat", "stringency_index")], by = c("time", "cat"))
new_time$stringency_index[is.na(new_time$stringency_index)] <- 0
if (stringency == FALSE) {
new_time <- expand.grid(
time = seq(min(df$time), max(df$time)*100, length.out = max(df$time)*100-min(df$time)+1),
cat = levels(df$cat)   # one dataset per group
)
pred_base <- predict(m_gam, newdata = new_time, se.fit = TRUE)
} else {
pred_base <- predict(m_gams, newdata = new_time, se.fit = TRUE)
}
new_time$fit <- pred_base$fit
new_time$se  <- pred_base$se.fit
# Find FIRST root where preds(t) == target
get_root_threshold <- function(time, preds, target) {
diff_sign <- diff(sign(preds - target))
crossings <- which(diff_sign != 0)
if (length(crossings) == 0) return(NA)
i <- crossings[1]  # first crossing
out <- tryCatch(
uniroot(function(t) {
approx(time, preds - target, xout = t)$y
},
lower = time[i],
upper = time[i + 1])$root,
error = function(e) NA
)
return(out)
}
alphas <- seq(0, 1, by = 0.05)   # adjust resolution as needed
# Bootstrap confidence intervals
set.seed(123)
n_boot <- 200   # increase to 500â€“1000 for publication
results_alpha <- map_df(levels(df$cat), function(g) {
group_data <- new_time %>% filter(cat == g)
# group-specific y(t=0): use earliest time in grid for that group
idx0 <- which.min(group_data$time)
y0_group <- group_data$fit[idx0]
# For each alpha / target, bootstrap
map_df(seq_along(alphas), function(j) {
alpha   <- alphas[j]
target <- (1 - alpha) * y0_group
boot_roots <- replicate(n_boot, {
# simulate one curve from uncertainty
y_sim <- rnorm(nrow(group_data), mean = group_data$fit, sd = group_data$se)
get_root_threshold(group_data$time, y_sim, target)
})
data.frame(
cat        = g,
alpha    = alpha,
y_target = target,
t_alpha  = median(boot_roots, na.rm = TRUE),
CI_lower = quantile(boot_roots, 0.025, na.rm = TRUE),
CI_upper = quantile(boot_roots, 0.975, na.rm = TRUE),
SD_t_alpha = sd(boot_roots, na.rm = TRUE)
)
})
})
results_alpha <- as_tibble(results_alpha)
if (stringency == FALSE) {
if (capital == TRUE) {
file_results_alpha <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/recovery-times-capital-gam-r1.csv')
} else {
file_results_alpha <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/recovery-times-fuas-gam-r1.csv')
}
} else {
if (capital == TRUE) {
file_results_alpha <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/recovery-times-capital-gams-r1.csv')
} else {
file_results_alpha <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/recovery-times-fuas-gams-r1.csv')
}
}
write.csv(results_alpha, file_results_alpha, row.names = FALSE)
# data wrangling
library(tidyverse)
# data utilities
library(timetk)
# estimating mixed effects models
library(lme4)
library(merTools)
library(glmmTMB)
library(nlme)
# correlograms
library(ggcorrplot)
library(corrplot)
# data visualisation
library(viridis)
library(ggthemes)
library(ggpubr)
library(zoo)
library(showtext)
library(patchwork)
library(ggrepel)
# display regression equation
library(equatiomatic)
# standardise input variables
#library(arm)
# reporting regression results
library(broom.mixed)
library(gtsummary)
library(sjPlot)
library(modelsummary)
library(brms)
# Set working directory
wd <- '/your/path/to/working/directory/'
wd <- '/Users/carmen/Library/CloudStorage/OneDrive-TheUniversityofLiverpool/research/latin-mobility-covid'
# Set the country
country <- 'Argentina'
# Initialize variables for country_short and country_code
country_short <- ""
country_code <- ""
# Assign country_short and country_code based on the country
if (country == 'Argentina') {
country_short <- 'ARG'
country_code <- 'AR'
} else if (country == 'Chile') {
country_short <- 'CHL'
country_code <- 'CL'
} else if (country == 'Colombia') {
country_short <- 'COL'
country_code <- 'CO'
}
category <- "density"
# Read the CSV file
file_path <- paste0(wd, '/data/outputs/', country_short, '/mov-analysis/by-', category, '/data_trend_new.csv')
df <- read.csv(file_path)
df$time2 <- df$time^2
dates <- read.csv(paste0(wd, '/data/outputs/', country_short, '/mov-analysis/dates.csv'))
df_stringency <- read.csv(paste0(wd, '/data/inputs/covid-stringency/owid-covid-data.csv')) %>%
filter(location == country) %>%
filter(date %in% dates$date) %>%
slice(seq(1, n(), by = 7)) %>%
mutate(time = seq(0, n() - 1)) %>%
select(time, stringency_index)
df <- df %>% left_join(df_stringency, by = "time") %>% rename("O" = "cat")
eq1 <- y ~ time
m1 <- glmmTMB(eq1, data = df)
###
eq1s <- y ~ time + stringency_index
m1s <- glmmTMB(eq1s, data = df)
###
# eq2 <- y ~ time + O + D
# m2 <- glmmTMB(eq2, data = df)
#
# eq2s <- y ~ time + O + D + stringency_index
# m2s <- glmmTMB(eq2s, data = df)
eq2o <- y ~ time + O
m2o <- glmmTMB(eq2o, data = df)
eq2os <- y ~ time + O + stringency_index
m2os <- glmmTMB(eq2os, data = df)
###
# eq3 <- y ~ time + (1|O) + (1|D)
# m3 <- glmmTMB(eq3, data = df)
# m3_re <- plot_model(m3, type ="re")
#
# eq3s <- y ~ time + (1|O) + (1|D) + stringency_index
# m3s <- glmmTMB(eq3s, data = df)
# m3s_re <- plot_model(m3s, type ="re")
eq3o <- y ~ time + (1|O)
m3o <- glmmTMB(eq3o, data = df)
m3o_re <- plot_model(m3o, type ="re")
eq3os <- y ~ time + (1|O) + stringency_index
m3os <- glmmTMB(eq3os, data = df)
m3os_re <- plot_model(m3os, type ="re")
###
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq4 <- y ~ time + (0 + time|Of) + (0 + time|Df)
# m4 <- glmmTMB(eq4, data = df)
# m4_re <- plot_model(m4, type ="re")
#
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq4s <- y ~ time + (0 + time|Of) + (0 + time|Df) + stringency_index
# m4s <- glmmTMB(eq4s, data = df)
# m4s_re <- plot_model(m4s, type ="re")
df$Of <- factor(df$O)
eq4o <- y ~ time + (0 + time|Of)
m4o <- glmmTMB(eq4o, data = df)
m4o_re <- plot_model(m4o, type ="re")
df$Of <- factor(df$O)
eq4os <- y ~ time + (0 + time|Of) + stringency_index
m4os <- glmmTMB(eq4os, data = df)
m4os_re <- plot_model(m4os, type ="re")
###
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq5 <- y ~ time + (time|Of) + (time|Df) + ratio
# m5 <- glmmTMB(eq5, data = df)
# m5_re <- plot_model(m5, type ="re")
#
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq5s <- y ~ time + (time|Of) + (time|Df) + stringency_index + ratio
# m5s <- glmmTMB(eq5s, data = df)
# m5s_re <- plot_model(m5s, type ="re")
df$Of <- factor(df$O)
eq5o <- y ~ time + (time|Of)
m5o <- glmmTMB(eq5o, data = df)
m5o_re <- plot_model(m5o, type ="re")
df$Of <- factor(df$O)
eq5os <- y ~ time + (time|Of) + stringency_index
m5os <- glmmTMB(eq5os, data = df)
m5os_re <- plot_model(m5os, type ="re")
###
# eq6 <- y ~ time + time2 + (time|O) + (time|D) + ratio
# m6 <- glmmTMB(eq6, data = df)
# m6_re <- plot_model(m6, type ="re")
#
# eq6s <- y ~ time + time2 + (time|O) + (time|D) + stringency_index + ratio
# m6s <- glmmTMB(eq6s, data = df)
# m6s_re <- plot_model(m6s, type ="re")
eq6o <- y ~ time + time2 + (time|O)
m6o <- glmmTMB(eq6o, data = df)
m6o_re <- plot_model(m6o, type ="re")
eq6os <- y ~ time + time2 + (time|O) + stringency_index
m6os <- glmmTMB(eq6os, data = df)
m6os_re <- plot_model(m6os, type ="re")
###
# eq7 <- y ~ time + time2 + (time + time2|O) + (time + time2|D) + ratio
# m7 <- glmmTMB(eq7, data = df)
# m7_re <- plot_model(m7, type ="re")
#
# eq7s <- y ~ time + time2 + (time + time2|O) + (time + time2|D) + stringency_index + ratio
# m7s <- glmmTMB(eq7s, data = df)
# m7s_re <- plot_model(m7s, type ="re")
eq7o <- y ~ time + time2 + (time + time2|O)
m7o <- glmmTMB(eq7o, data = df)
m7o_re <- plot_model(m7o, type ="re")
eq7os <- y ~ time + time2 + (time + time2|O) + stringency_index
m7os <- glmmTMB(eq7os, data = df)
m7os_re <- plot_model(m7os, type ="re")
df$O  <- factor(df$O)
eq8o <- y ~
s(time, k = 8) +
s(time, O, bs = "fs", k = 7)
m_gam <- gam(eq8o, data = df, method = "REML")
# data wrangling
library(tidyverse)
# data utilities
library(timetk)
# estimating mixed effects models
library(lme4)
library(merTools)
library(glmmTMB)
library(nlme)
# correlograms
library(ggcorrplot)
library(corrplot)
# data visualisation
library(viridis)
library(ggthemes)
library(ggpubr)
library(zoo)
library(showtext)
library(patchwork)
library(ggrepel)
# display regression equation
library(equatiomatic)
# standardise input variables
#library(arm)
# reporting regression results
library(broom.mixed)
library(gtsummary)
library(sjPlot)
library(modelsummary)
library(mgcv)
eq1 <- y ~ time
m1 <- glmmTMB(eq1, data = df)
###
eq1s <- y ~ time + stringency_index
m1s <- glmmTMB(eq1s, data = df)
###
# eq2 <- y ~ time + O + D
# m2 <- glmmTMB(eq2, data = df)
#
# eq2s <- y ~ time + O + D + stringency_index
# m2s <- glmmTMB(eq2s, data = df)
eq2o <- y ~ time + O
m2o <- glmmTMB(eq2o, data = df)
eq2os <- y ~ time + O + stringency_index
m2os <- glmmTMB(eq2os, data = df)
###
# eq3 <- y ~ time + (1|O) + (1|D)
# m3 <- glmmTMB(eq3, data = df)
# m3_re <- plot_model(m3, type ="re")
#
# eq3s <- y ~ time + (1|O) + (1|D) + stringency_index
# m3s <- glmmTMB(eq3s, data = df)
# m3s_re <- plot_model(m3s, type ="re")
eq3o <- y ~ time + (1|O)
m3o <- glmmTMB(eq3o, data = df)
m3o_re <- plot_model(m3o, type ="re")
eq3os <- y ~ time + (1|O) + stringency_index
m3os <- glmmTMB(eq3os, data = df)
m3os_re <- plot_model(m3os, type ="re")
###
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq4 <- y ~ time + (0 + time|Of) + (0 + time|Df)
# m4 <- glmmTMB(eq4, data = df)
# m4_re <- plot_model(m4, type ="re")
#
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq4s <- y ~ time + (0 + time|Of) + (0 + time|Df) + stringency_index
# m4s <- glmmTMB(eq4s, data = df)
# m4s_re <- plot_model(m4s, type ="re")
df$Of <- factor(df$O)
eq4o <- y ~ time + (0 + time|Of)
m4o <- glmmTMB(eq4o, data = df)
m4o_re <- plot_model(m4o, type ="re")
df$Of <- factor(df$O)
eq4os <- y ~ time + (0 + time|Of) + stringency_index
m4os <- glmmTMB(eq4os, data = df)
m4os_re <- plot_model(m4os, type ="re")
###
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq5 <- y ~ time + (time|Of) + (time|Df) + ratio
# m5 <- glmmTMB(eq5, data = df)
# m5_re <- plot_model(m5, type ="re")
#
# df$Of <- factor(df$O)
# df$Df <- factor(df$D)
# eq5s <- y ~ time + (time|Of) + (time|Df) + stringency_index + ratio
# m5s <- glmmTMB(eq5s, data = df)
# m5s_re <- plot_model(m5s, type ="re")
df$Of <- factor(df$O)
eq5o <- y ~ time + (time|Of)
m5o <- glmmTMB(eq5o, data = df)
m5o_re <- plot_model(m5o, type ="re")
df$Of <- factor(df$O)
eq5os <- y ~ time + (time|Of) + stringency_index
m5os <- glmmTMB(eq5os, data = df)
m5os_re <- plot_model(m5os, type ="re")
###
# eq6 <- y ~ time + time2 + (time|O) + (time|D) + ratio
# m6 <- glmmTMB(eq6, data = df)
# m6_re <- plot_model(m6, type ="re")
#
# eq6s <- y ~ time + time2 + (time|O) + (time|D) + stringency_index + ratio
# m6s <- glmmTMB(eq6s, data = df)
# m6s_re <- plot_model(m6s, type ="re")
eq6o <- y ~ time + time2 + (time|O)
m6o <- glmmTMB(eq6o, data = df)
m6o_re <- plot_model(m6o, type ="re")
eq6os <- y ~ time + time2 + (time|O) + stringency_index
m6os <- glmmTMB(eq6os, data = df)
m6os_re <- plot_model(m6os, type ="re")
###
# eq7 <- y ~ time + time2 + (time + time2|O) + (time + time2|D) + ratio
# m7 <- glmmTMB(eq7, data = df)
# m7_re <- plot_model(m7, type ="re")
#
# eq7s <- y ~ time + time2 + (time + time2|O) + (time + time2|D) + stringency_index + ratio
# m7s <- glmmTMB(eq7s, data = df)
# m7s_re <- plot_model(m7s, type ="re")
eq7o <- y ~ time + time2 + (time + time2|O)
m7o <- glmmTMB(eq7o, data = df)
m7o_re <- plot_model(m7o, type ="re")
eq7os <- y ~ time + time2 + (time + time2|O) + stringency_index
m7os <- glmmTMB(eq7os, data = df)
m7os_re <- plot_model(m7os, type ="re")
df$O  <- factor(df$O)
eq8o <- y ~
s(time, k = 8) +
s(time, O, bs = "fs", k = 7)
m_gam <- gam(eq8o, data = df, method = "REML")
df$O  <- factor(df$O)
eq8os <- y ~
s(time, k = 8) +
stringency_index +
s(time, O, bs = "fs", k = 7)
m_gams <- gam(eq8os, data   = df, method = "REML")
packageVersion("mgcv")
